name: Terraform Plan and Apply

on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Docker image URI to deploy'
        required: true
        type: string
      workspace:
        description: 'Terraform workspace'
        required: false
        type: string
        default: 'default'
      terraform_action:
        description: 'Terraform action (plan or apply)'
        required: false
        type: string
        default: 'plan'

permissions:
  contents: read
  id-token: write
  pull-requests: write  # For PR comments

concurrency:
  group: terraform-deploy-${{ inputs.workspace }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform ${{ inputs.terraform_action }}
    runs-on: ubuntu-latest

    env:
      # Required Terraform variables
      TF_VAR_project: ${{ vars.GCP_PROJECT_ID }}
      TF_VAR_location: ${{ vars.GCP_LOCATION }}
      TF_VAR_agent_name: ${{ vars.IMAGE_NAME }}
      TF_VAR_terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
      TF_VAR_docker_image: ${{ inputs.docker_image }}

      # Optional Terraform variables (Github Actions will default to empty strings if not set)
      TF_VAR_adk_suppress_experimental_feature_warnings: ${{ vars.ADK_SUPPRESS_EXPERIMENTAL_FEATURE_WARNINGS }}
      TF_VAR_agent_engine: ${{ vars.AGENT_ENGINE }}
      TF_VAR_allow_origins: ${{ vars.ALLOW_ORIGINS }}
      TF_VAR_artifact_service_uri: ${{ vars.ARTIFACT_SERVICE_URI }}
      TF_VAR_log_level: ${{ vars.LOG_LEVEL }}
      TF_VAR_root_agent_model: ${{ vars.ROOT_AGENT_MODEL }}
      TF_VAR_serve_web_interface: ${{ vars.SERVE_WEB_INTERFACE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.14.0"
          terraform_wrapper: false  # Better output handling

      - name: Terraform Format Check
        id: fmt
        working-directory: terraform/main
        run: terraform fmt -check -recursive

      - name: Terraform Init
        id: init
        working-directory: terraform/main
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TERRAFORM_STATE_BUCKET }}"

      - name: Terraform Validate
        id: validate
        working-directory: terraform/main
        run: |
          OUTPUT=$(terraform validate -no-color 2>&1)
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        working-directory: terraform/main
        run: |
          terraform workspace select --or-create ${{ inputs.workspace }}
          OUTPUT=$(terraform plan -no-color -input=false -out=tfplan 2>&1)
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Extract step results
            const results = {
              fmt: '${{ steps.fmt.outcome }}',
              init: '${{ steps.init.outcome }}',
              validate: '${{ steps.validate.outcome }}',
              plan: '${{ steps.plan.outcome }}',
              validateOutput: `${{ steps.validate.outputs.stdout }}` || 'No output',
              planOutput: `${{ steps.plan.outputs.stdout }}` || 'No plan available'
            };

            // Map outcomes to icons
            const statusIcon = (outcome) => {
              const icons = {
                success: 'âœ…',
                failure: 'âŒ',
                skipped: 'â­ï¸',
                cancelled: 'ğŸš«',
                timed_out: 'â±ï¸'
              };
              return icons[outcome] || 'â“';
            };

            // Build comment body
            const body = `
            ## Terraform Plan Summary

            | Step | Status |
            |------|:------:|
            | ğŸ–Œ Format & Style | ${statusIcon(results.fmt)} \`${results.fmt}\` |
            | âš™ï¸ Initialization | ${statusIcon(results.init)} \`${results.init}\` |
            | ğŸ¤– Validation | ${statusIcon(results.validate)} \`${results.validate}\` |
            | ğŸ“– Plan | ${statusIcon(results.plan)} \`${results.plan}\` |

            <details><summary>Validation Output</summary>

            \`\`\`
            ${results.validateOutput}
            \`\`\`

            </details>

            <details><summary>Plan Output</summary>

            \`\`\`terraform
            ${results.planOutput}
            \`\`\`

            </details>

            ---
            *Pushed by @${{ github.actor }} Â· ${{ github.event_name }}*
            `.trim();

            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Apply
        id: apply
        if: inputs.terraform_action == 'apply'
        working-directory: terraform/main
        run: |
          terraform workspace select ${{ inputs.workspace }}
          terraform apply -auto-approve -input=false tfplan

      - name: Output Service URL
        if: inputs.terraform_action == 'apply'
        working-directory: terraform/main
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo ""
          echo "ğŸ“ Cloud Run Services:"
          terraform output -json cloud_run_services | jq -r 'to_entries[] | "  \(.key): \(.value.uri)"'

      - name: Generate Job Summary
        if: always()
        working-directory: terraform/main
        run: |
          # Map outcomes to icons
          fmt_icon="â“"
          init_icon="â“"
          validate_icon="â“"
          plan_icon="â“"
          apply_icon="â“"

          [ "${{ steps.fmt.outcome }}" == "success" ] && fmt_icon="âœ…"
          [ "${{ steps.fmt.outcome }}" == "failure" ] && fmt_icon="âŒ"
          [ "${{ steps.fmt.outcome }}" == "skipped" ] && fmt_icon="â­ï¸"

          [ "${{ steps.init.outcome }}" == "success" ] && init_icon="âœ…"
          [ "${{ steps.init.outcome }}" == "failure" ] && init_icon="âŒ"
          [ "${{ steps.init.outcome }}" == "skipped" ] && init_icon="â­ï¸"

          [ "${{ steps.validate.outcome }}" == "success" ] && validate_icon="âœ…"
          [ "${{ steps.validate.outcome }}" == "failure" ] && validate_icon="âŒ"
          [ "${{ steps.validate.outcome }}" == "skipped" ] && validate_icon="â­ï¸"

          [ "${{ steps.plan.outcome }}" == "success" ] && plan_icon="âœ…"
          [ "${{ steps.plan.outcome }}" == "failure" ] && plan_icon="âŒ"
          [ "${{ steps.plan.outcome }}" == "skipped" ] && plan_icon="â­ï¸"

          [ "${{ steps.apply.outcome }}" == "success" ] && apply_icon="âœ…"
          [ "${{ steps.apply.outcome }}" == "failure" ] && apply_icon="âŒ"
          [ "${{ steps.apply.outcome }}" == "skipped" ] && apply_icon="â­ï¸"

          # Determine overall status
          if [ "${{ inputs.terraform_action }}" == "apply" ]; then
            if [ "${{ steps.apply.outcome }}" == "success" ]; then
              OVERALL_STATUS="âœ… Apply Successful"
            elif [ "${{ steps.apply.outcome }}" == "failure" ]; then
              OVERALL_STATUS="âŒ Apply Failed"
            else
              OVERALL_STATUS="âš ï¸ Apply Incomplete"
            fi
          else
            if [ "${{ steps.plan.outcome }}" == "success" ]; then
              OVERALL_STATUS="âœ… Plan Successful"
            elif [ "${{ steps.plan.outcome }}" == "failure" ]; then
              OVERALL_STATUS="âŒ Plan Failed"
            else
              OVERALL_STATUS="âš ï¸ Plan Incomplete"
            fi
          fi

          # Write summary header
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸš€ Terraform Deployment Summary

          ### Configuration
          - **Workspace:** \`${{ inputs.workspace }}\`
          - **Action:** \`${{ inputs.terraform_action }}\`
          - **Docker Image:** \`${{ inputs.docker_image }}\`

          ### ${OVERALL_STATUS}

          | Step | Status | Outcome |
          |------|:------:|---------|
          | ğŸ–Œ Format Check | ${fmt_icon} | \`${{ steps.fmt.outcome }}\` |
          | âš™ï¸ Initialize | ${init_icon} | \`${{ steps.init.outcome }}\` |
          | ğŸ¤– Validate | ${validate_icon} | \`${{ steps.validate.outcome }}\` |
          | ğŸ“– Plan | ${plan_icon} | \`${{ steps.plan.outcome }}\` |
          EOF

          # Add apply row if applicable
          if [ "${{ inputs.terraform_action }}" == "apply" ]; then
            echo "| ğŸš€ Apply | ${apply_icon} | \`${{ steps.apply.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          # Add plan output (first 50 lines) - only if plan step succeeded
          if [ "${{ steps.plan.outcome }}" == "success" ] && [ -n "${{ steps.plan.outputs.stdout }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>ğŸ“‹ Terraform Plan Output (first 50 lines)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```terraform' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.plan.outputs.stdout }}" | head -n 50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          # Add terraform outputs for successful apply
          if [ "${{ inputs.terraform_action }}" == "apply" ] && [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ Deployed Resources" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Get Cloud Run service URLs
            CLOUD_RUN_SERVICES=$(terraform output -json cloud_run_services 2>/dev/null || echo "{}")
            if echo "$CLOUD_RUN_SERVICES" | jq -e 'length > 0' >/dev/null 2>&1; then
              echo "#### Cloud Run Services" >> $GITHUB_STEP_SUMMARY
              echo "$CLOUD_RUN_SERVICES" | jq -r 'to_entries[] | "- **\(.key):** [\(.value.uri)](\(.value.uri))"' >> $GITHUB_STEP_SUMMARY
            fi

            # Get other key outputs if they exist
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Additional Outputs" >> $GITHUB_STEP_SUMMARY

            # Capture outputs to variables first to avoid duplicate execution
            SERVICE_ACCOUNT_EMAIL=$(terraform output -raw service_account_email 2>/dev/null || echo "")
            AGENT_ENGINE_ID=$(terraform output -raw agent_engine_id 2>/dev/null || echo "")
            ARTIFACT_BUCKET_NAME=$(terraform output -raw artifact_bucket_name 2>/dev/null || echo "")

            # Service account
            if [ -n "$SERVICE_ACCOUNT_EMAIL" ]; then
              echo "- **Service Account:** \`${SERVICE_ACCOUNT_EMAIL}\`" >> $GITHUB_STEP_SUMMARY
            fi

            # Agent Engine (if exists)
            if [ -n "$AGENT_ENGINE_ID" ]; then
              echo "- **Agent Engine ID:** \`${AGENT_ENGINE_ID}\`" >> $GITHUB_STEP_SUMMARY
            fi

            # Artifact bucket
            if [ -n "$ARTIFACT_BUCKET_NAME" ]; then
              echo "- **Artifact Bucket:** \`gs://${ARTIFACT_BUCKET_NAME}\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Add footer
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by @${{ github.actor }} Â· ${{ github.event_name }} Â· workspace: \`${{ inputs.workspace }}\`*" >> $GITHUB_STEP_SUMMARY
