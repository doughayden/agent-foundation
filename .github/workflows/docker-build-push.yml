name: Build

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'Dockerfile'
      - '.dockerignore'
      - '.github/workflows/docker-build-push.yml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-push:
    name: Build and Push to Artifact Registry
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for better git metadata

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ vars.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev

      - name: Extract metadata
        id: meta
        run: |
          # Generate image tags
          REGISTRY="${{ vars.ARTIFACT_REGISTRY_URI }}"
          IMAGE_NAME="${{ vars.IMAGE_NAME }}"
          SHA_SHORT=$(git rev-parse --short HEAD)

          # Build tag list
          TAGS="${REGISTRY}/${IMAGE_NAME}:latest"
          TAGS="${TAGS},${REGISTRY}/${IMAGE_NAME}:${SHA_SHORT}"

          # Add semantic version tag if available (from git tag)
          if VERSION=$(git describe --tags --exact-match 2>/dev/null); then
            TAGS="${TAGS},${REGISTRY}/${IMAGE_NAME}:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "sha-short=${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ vars.ARTIFACT_REGISTRY_URI }}/${{ vars.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ vars.ARTIFACT_REGISTRY_URI }}/${{ vars.IMAGE_NAME }}:buildcache,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Output image details
        run: |
          echo "âœ… Docker image built and pushed successfully"
          echo ""
          echo "ðŸ“¦ Image tags:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | sed 's/^/  - /'
          echo ""
          echo "ðŸ”— Artifact Registry URI: ${{ vars.ARTIFACT_REGISTRY_URI }}"
